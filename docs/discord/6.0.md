# BotOfTheSpecter Discord Bot - Version 6.0 (2025-12-14)

## Version Information

* Updated version from 5.9 to 6.0
* Focused on Role Tracking system with granular tracking control and audit log integration

## New Features & Major Changes

### Role Tracking Configuration

* Added comprehensive `RoleTrackingCog` to track all role additions and removals on Discord members
* Created `role_tracking_logs` database table to store detailed role change history with timestamps
* Added `role_tracking_configuration` JSON column to `server_management` table for per-guild settings

### Granular Tracking Options

* Implemented dual-checkbox tracking options allowing admins to independently control:
  * **Track Role Additions**: Log when members receive roles
  * **Track Role Removals**: Log when members lose roles
* Settings stored as JSON configuration for flexibility and future expansion
* Default behavior: Both tracking options enabled (tracks all role changes)

### Audit Log Integration

* Integrated Discord audit logs to capture who made each role change (moderator/bot name)
* Automatically queries recent audit log entries when role changes occur
* Stores `changed_by` field with moderator information for accountability
* Graceful fallback to "Unknown" if audit logs are inaccessible or unavailable

### Server Role Management Configuration

* Added `ServerRoleManagementCog` to track role creation and deletion within Discord servers
* Created `server_role_management_logs` database table to store role management history
* Added `server_role_management_configuration` JSON column to `server_management` table
* Implemented granular tracking options:
  * **Track Role Creation**: Log when new roles are created
  * **Track Role Deletion**: Log when roles are deleted
  * **Track Role Edits**: Log when roles are modified (name, color, permissions, mentionable, hoist status)
* Captures audit log information showing who created/deleted/edited roles
* Posts color-coded embeds to configured log channel:
  * Green embeds for role creation
  * Red embeds for role deletion
  * Orange embeds for role edits
* Dashboard configuration allows independent control of creation/deletion/edit tracking

### Message Tracking Configuration

* Added comprehensive `MessageTrackingCog` to track message edits and deletions in Discord servers
* Created `message_tracking_logs` database table to store detailed message tracking history
* Added `message_tracking_configuration` JSON column to `server_management` table for per-guild settings
* Implemented granular tracking options allowing admins to independently control:
  * **Track Message Edits**: Log when members edit messages
  * **Track Message Deletions**: Log when members delete messages
* Stores original and edited content for complete message history
* Captures user information and timestamp for all tracked messages
* Posts color-coded embeds to configured log channel:
  * Orange embeds for message edits
  * Red embeds for message deletions
* Dashboard configuration with channel selector and dual-checkbox tracking options

### User Tracking Configuration

* Added `UserTrackingCog` to track user join and leave events in Discord servers
* Created `user_tracking_logs` database table to store user activity history
* Added `user_tracking_configuration` JSON column to `server_management` table
* Implemented granular tracking options:
  * **Track User Joins**: Log when users join the server
  * **Track User Leaves**: Log when users leave the server
* Captures user information and join/leave timestamps
* Posts color-coded embeds to configured log channel:
  * Green embeds for user joins (includes account creation date)
  * Red embeds for user leaves (includes join date)
* Dashboard configuration allows independent control of join/leave tracking

### Stream Schedule Configuration

* Added `post_stream_schedule_message()` method in `ServerManagement` cog to post streaming schedule embeds
* Created `stream_schedule_messages` database table to cache posted schedules with separate timezone message tracking
* Added websocket event handler `POST_STREAM_SCHEDULE_MESSAGE` for real-time message posting
* **Automatic Timezone Conversions with Live Updates**:
  * Main schedule embed includes "Stream Schedule Timezone" field with:
    * Current time in user's selected base timezone (with full timezone name)
    * Conversions to major timezones: UTC, US East, US West, US Central, US Mountain, London, Tokyo
  * Posts separate timezone message below main schedule that updates **every minute** with live times
  * Automatically deletes old timezone message when schedule is updated
  * Easy for viewers to see stream time in their timezone without calculating
* Automatically links schedule title to user's Twitch schedule page (`https://www.twitch.tv/{USERNAME}/schedule`)
* Automatically removes old schedule and timezone messages before posting new ones to keep channel clean
* Stores schedule with configurable:
  * **Schedule Title**: Custom title for the schedule embed (automatically linked to Twitch schedule)
  * **Schedule Content**: Full streaming schedule content
  * **Schedule Color**: Hex color for embed visualization
  * **Timezone**: Base timezone for schedule (user's primary timezone for conversions)
* Posts formatted embeds to configured Discord channel with color-coded presentation
* Caches posted messages in database for history and management tracking (stores both schedule and timezone message IDs)
* Dashboard configuration with channel selector, title/content inputs, color picker, and timezone selection

### Discord Timestamp Utilities

* Added `UtilityCog` with timestamp conversion commands for users
* New command: `!timestamp <unix_epoch_or_date>` (aliases: `!ts`, `!discordtime`)
  * Converts Unix epoch timestamps or date/time strings to Discord timestamp formats
  * Supports multiple date formats: YYYY-MM-DD HH:MM:SS, MM/DD/YYYY, relative dates, and more
  * Returns embed showing all 8 Discord timestamp format variations:
    * Short Date Time: `<t:1624855717>`
    * Short Date Time (alt): `<t:1624855717:f>`
    * Long Date Time: `<t:1624855717:F>`
    * Short Date: `<t:1624855717:d>`
    * Long Date: `<t:1624855717:D>`
    * Short Time: `<t:1624855717:t>`
    * Long Time: `<t:1624855717:T>`
    * Relative Time: `<t:1624855717:R>`
  * Validates Unix timestamps are in reasonable range (2000-2100)
  * Provides helpful error messages for invalid input
* New command: `!epochnow` (aliases: `!now`, `!currenttime`)
  * Shows current Unix timestamp in all Discord timestamp format variations
  * Helps users understand how timestamps render in their current timezone

### Database Schema

* New table: `role_tracking_logs` with columns:
  * `id` (auto-increment primary key)
  * `server_id` (guild identifier)
  * `user_id` (member who had role changed)
  * `username` (member's display name)
  * `action` ('added' or 'removed')
  * `role_id` (role that was changed)
  * `role_name` (role display name)
  * `changed_by` (moderator/user who made the change)
  * `changed_at` (timestamp of change)
  * Indexes on `server_id`, `user_id`, and `changed_at` for efficient querying

* New table: `server_role_management_logs` with columns:
  * `id` (auto-increment primary key)
  * `server_id` (guild identifier)
  * `action` ('created' or 'deleted')
  * `role_id` (role that was created/deleted)
  * `role_name` (role display name)
  * `created_by` (user who created/deleted the role)
  * `created_at` (timestamp of change)
  * Indexes on `server_id`, `action`, and `created_at` for efficient querying

* New table: `message_tracking_logs` with columns:
  * `id` (auto-increment primary key)
  * `server_id` (guild identifier)
  * `channel_id` (channel where message was posted)
  * `message_id` (unique message identifier)
  * `user_id` (user who posted the message)
  * `username` (user's display name)
  * `action` ('edited' or 'deleted')
  * `original_content` (message content before edit or full content if deleted)
  * `edited_content` (new message content if edited, NULL if deleted)
  * `tracked_at` (timestamp of edit/deletion)
  * Indexes on `server_id`, `channel_id`, `user_id`, `action`, and `tracked_at` for efficient querying

* New table: `user_tracking_logs` with columns:
  * `id` (auto-increment primary key)
  * `server_id` (guild identifier)
  * `user_id` (user who joined or left)
  * `username` (user's display name)
  * `action` ('joined' or 'left')
  * `tracked_at` (timestamp of join/leave event)
  * Indexes on `server_id`, `user_id`, `action`, and `tracked_at` for efficient querying

* New table: `stream_schedule_messages` with columns:
  * `id` (auto-increment primary key)
  * `server_id` (guild identifier)
  * `channel_id` (channel where message posted)
  * `message_id` (posted message identifier)
  * `title` (schedule embed title)
  * `schedule_content` (main schedule text content)
  * `color` (hex color code for embed)
  * `timezone` (optional timezone display)
  * `created_at` (timestamp of message post)
  * `updated_at` (timestamp of last update)
  * Indexes on `server_id` and `message_id` for efficient querying

### Event Listeners

* `on_member_update` listener monitors all member role changes
  * Respects granular tracking settings (only logs additions if enabled, only logs removals if enabled)
  * Posts color-coded embeds to configured log channel (green for additions, red for removals)
  * Includes member information, role details, and formatted timestamps in embeds

* `on_message_edit` listener monitors message edits
  * Respects granular tracking setting (only logs if track_edits enabled)
  * Logs both original and edited content to database
  * Posts orange embed to configured log channel with side-by-side content comparison
  * Includes user information, channel mention, and timestamps

* `on_message_delete` listener monitors message deletions
  * Respects granular tracking setting (only logs if track_deletes enabled)
  * Logs full message content before deletion
  * Posts red embed to configured log channel with deleted message details
  * Includes user information, channel mention, and timestamps

* `on_guild_role_create` listener monitors new role creation
  * Captures who created the role from audit logs
  * Logs to database and posts embed to configured log channel
  * Includes role information and creation details

* `on_guild_role_delete` listener monitors role deletion
  * Captures who deleted the role from audit logs
  * Logs to database and posts embed to configured log channel
  * Includes role information and deletion details

* `on_guild_role_update` listener monitors role edits
  * Tracks changes to name, color, permissions, mentionable, and hoist status
  * Captures who edited the role from audit logs
  * Posts orange embed to configured log channel with detailed change list
  * Excludes position changes to avoid spam from role sorting

* `on_member_join` listener monitors user join events
  * Logs to database and posts embed to configured log channel
  * Includes user information, user ID, and account creation date
  * Respects granular tracking setting (only logs if track_joins enabled)

* `on_member_remove` listener monitors user leave events
  * Logs to database and posts embed to configured log channel
  * Includes user information, user ID, and join date
  * Respects granular tracking setting (only logs if track_leaves enabled)

### Role History Integration

* Role Tracking updates `role_history` table when enabled
* Maintains current role snapshot for member role history analysis
* Works seamlessly alongside Role History feature for comprehensive role analytics

## Bug Fixes & Improvements

* Logging and monitoring of role tracking and role management operations
* Graceful handling of missing or inaccessible Discord channels
* **Code Cleanup**: Removed all verified database table initialization and schema verification code
  * Eliminated redundant `CREATE TABLE IF NOT EXISTS` statements across all cogs
  * Removed schema verification methods (`_ensure_table_schema`, `_ensure_*_table`, etc.)
  * Removed migration methods (`_migrate_server_management_table`) from individual cogs
  * Removed database initialization methods (`_init_*_database`, `_init_*_table`)
  * Cleaner codebase focusing on actual database operations rather than setup verification

**Thank you for your feedback and support!**

As always, your feedback is appreciated. Please report any issues or suggestions in the #ticket-info channel on our Discord server. You can also submit feedback directly on our website: [https://botofthespecter.com/feedback.php](https://botofthespecter.com/feedback.php)
