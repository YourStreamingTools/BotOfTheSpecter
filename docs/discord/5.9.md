# BotOfTheSpecter Discord Bot - Version 5.9 (2025-11-17)

## Version Information
* Updated version from 5.8 to 5.9
* Focused on Twitch Live Channels management, duplicate-post prevention, and improved Twitch Helix integration for reliable live detection

## New Features & Major Changes

### Live Channels Management
* Added `LiveChannelManager` class to persist and manage currently online Twitch streams across websocket and API fallback events
* Created `online_streams` DB table to store per-channel online state (username, twitch_user_id, stream_id, started_at, details), with schema checks and index creation
* Implemented `mark_online`/`mark_offline` methods to centralize online-state handling and coordinate with `live_notifications` for dedupe
** IMPORTANT: The Helix fallback/posting behavior implemented here applies only to the streamers who run the bot (channel owners). Tracked users (member_streams) are unchanged and still rely on the member-stream posting logic in `StreamerPostingCog`. **

### Twitch Helix Integration & Batch Checks
* Implemented `twitch_get_streams_by_logins()` helper which batches up to 100 `user_login` values per Helix call and uses `type=live` to reduce noise
* Added `start_periodic_validation()` to re-check persisted online streams periodically to handle missing websocket events or missed messages
* Fallback checks via Helix used in `fallback_check_and_mark()` when the websocket or local `get_stream_info()` can't confirm a stream

### Duplicate Prevention & Case-Insensitive Matching
* `post_live_notification` now checks both `online_streams` and `live_notifications` to prevent duplicate posts for the same stream id
* Queries and persistence for usernames are now normalized and performed case-insensitively (using `LOWER(username)` in SQL queries and lowercasing before inserts) to ensure consistent matching against Helix `user_login`

### Robustness & Schema Upgrades
* Added schema ensure & migration code paths to change older tables to required columns and indices when missing
* Silent fallback to bot-level auth token if per-user OAuth token returns 401 for Helix calls
* Normalized ISO8601 `started_at` timestamps before storing into MySQL DATETIME fields

### Operational Behavior
* The bot monitors the list of usernames configured under each owner's `member_streams` table (the `discord_users` table configures which guilds use member streams) and only checks those users via Helix, respecting `member_streams_id` and Discord channel permissions
* Periodic validation uses the central `online_streams` DB table and will mark offline accounts as necessary to keep the database consistency and allow future reposts

## Bug Fixes & Improvements
* Fixes to case-sensitive username mismatches that could cause duplicate or missing post behavior
* Better error handling and logging for DB and Helix API failures
* Minor refactor to ensure consistent db queries for username lookups

**Thank you for your support!**

If you find any issues, please report them at the #get-support channel on Discord or on our website: https://botofthespecter.com/feedback.php
