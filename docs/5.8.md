# Changelog - Version 5.8 (UPCOMING UPDATE)

## Version Information

* Updated version from 5.7.4 to 5.8
* Major architecture improvements and custom bot support

## New Features & Major Changes

* **Custom Bot Mode Support**
  * Added support for running the bot with custom bot accounts via database credentials
  * New `-botusername` command line argument for specifying custom bot username
  * Automatic credential fetching from `custom_bots` table in website database
  * Dynamic OAuth token selection based on bot mode (custom vs standard)
  * Comprehensive validation checks before bot initialization

* **AI-Powered Ad Break Notifications**
  * Integrated GPT-5-nano for generating contextual ad break messages
  * AI analyzes recent chat history to create personalized ad break announcements
  * Tracks ad break count per stream session for smarter messaging
  * Premium tier 2+ feature with automatic fallback to standard messages
  * Clears ad-break chat history immediately at the start/end of ad handling — always cleared even when AI ad-breaks are disabled or the user lacks AI permission, preventing accumulation of stale messages across streams
  * Filters out timed messages from AI context while preserving command responses
  * Includes stream title and game context for better awareness

* **Enhanced Ad Break Configuration**
  * Added individual toggle controls for each ad message type (upcoming, start, end, snoozed)
  * New database fields: `enable_upcoming_ad_message`, `enable_start_ad_message`, `enable_end_ad_message`, `enable_snoozed_ad_message`, `enable_ai_ad_breaks`
  * Improved ad break messaging logic with granular control
  * Better logging for ad notification debugging

* **Unified Points Management System**
  * New `manage_user_points()` function for centralized point operations
  * Supports get, credit, and debit actions with consistent return structure
  * Automatic user creation in bot_points table if not exists
  * Comprehensive error handling with detailed response objects
  * Prevents negative point balances

* **Improved Shoutout System**
  * New `get_shoutout_message()` function with game information integration
  * Different behavior for raid vs command-triggered shoutouts
  * Fetches latest stream game automatically for richer shoutout messages
  * Graceful fallback when game information unavailable
  * **Fixed shoutout queue blocking bug**: Reordered cooldown checks to prevent queue blocking when users are on per-user cooldown
    * Per-user cooldown (60 min) now checked before global cooldown (2 min) wait
    * Users on cooldown are skipped immediately without blocking other users in queue
    * Allows multiple different users to be shouted out every 2 minutes while respecting per-user limits
  * **Fixed `channel.shoutout.create` EventSub notification handling**
    * Fixed bug where `shoutout_user.lower()` was being called on a dictionary
    * Now properly detects command-triggered vs manual/UI-triggered shoutouts
    * Command-triggered shoutouts skip EventSub message to prevent duplicates
    * Manual/UI-triggered shoutouts now properly send chat messages via EventSub
    * Uses `get_shoutout_message()` function with "eventsub" action for consistent messaging
    * Fixed typo: "inforamtion" → "information" in error message

* **Known Users Timestamps**
  * Added `first_seen` and `last_seen` DATETIME columns to the `seen_users` table (nullable).
  * Bot behavior: `first_seen` is set to the current timestamp the first time a user is observed; `last_seen` is updated on every message.
  * Dashboard: `Known Users` page now displays First Seen/Last Seen columns and shows "Unknown" when timestamps are missing.
  * Migration: existing `last_seen` values are used to populate `first_seen` when appropriate.

* **URL Blocking System Overhaul**
  * **Blacklist Always Active**: Blacklisted URLs are now blocked regardless of URL blocking setting
    * Blacklist check happens first before any other URL validation
    * Sends "Code Red" alert to mods when blacklisted URL is detected
    * Ensures harmful/unwanted URLs are always blocked
  * **Regex Support for Whitelist**: Whitelist now supports full regex pattern matching
    * Allows flexible URL pattern matching (e.g., `.*\.example\.com` for subdomains)
    * Backwards compatible - can still use simple domain names
    * Invalid regex patterns are logged and skipped gracefully
  * **Improved Privilege Handling**: Mods and streamers bypass URL blocking when enabled
    * Clearer logging for privileged user URL allowances
    * Permit command functionality preserved
  * **Enhanced URL Blocking Logic**:
    * **Enabled**: Removes all links except whitelisted regex patterns and Twitch links
    * **Disabled**: Allows all URLs except blacklisted ones
    * Twitch.tv and clips.twitch.tv links always allowed when URL blocking enabled
  * **Better Logging**: More descriptive log messages for URL blocking decisions
    * Logs when blacklisted URLs are detected
    * Logs when URLs are allowed due to whitelist match
    * Logs when URLs are allowed due to mod/streamer privilege
    * Logs when non-whitelisted URLs are blocked

* **Text Term Blocking System**
  * **New Feature**: Block specific words from chat
  * Messages containing blocked terms are automatically deleted
  * Case-insensitive matching (e.g., "badword", "BADWORD", "BadWord" all match)
  * Independent enable/disable toggle separate from URL blocking
  * Single word per entry validation (no spaces allowed)
  * **Database Tables**:
    * Added `term_blocking` column to `protection` table (VARCHAR(500), default: 'False')
    * New `blocked_terms` table to store blocked terms list
  * **Dashboard Integration**:
    * New Term Blocking section in Chat Protection tab
    * Add/remove blocked terms with simple interface
    * Real-time validation prevents:
      * Adding terms that match global spam patterns
      * Adding terms already in URL whitelist or blacklist
      * Adding multi-word phrases (spaces not allowed)
    * Validation with 500ms debounce for better performance
    * Empty state messaging when no terms are configured
  * **Bot Logic**:
    * Scans all chat messages for blocked terms when enabled
    * Deletes messages containing blocked terms instantly
    * Sends notification to user explaining removal
    * Independent from URL blocking - can be enabled separately

## Code Improvements

* **Database Connection Refactoring**
  * Simplified MySQL handler using direct connections
  * Implemented `MySQLHandler` class with `get_connection()` method for consistent connection management
  * Created `PoolConnectionWrapper` class for async context manager support
  * All database calls now use `async with await mysql_handler.get_connection()` pattern
  * Automatic connection cleanup with proper resource management
  * Support for multi-database connections (user DB, website DB, spam_pattern DB)

* **Chat Message Enhancements**
  * Increased maximum message length from 255 to 500 characters
  * Updated `send_chat_message()` to support three bot modes:
    * **Self Mode** (`-self`): Uses broadcaster's own account as the bot
    * **Custom Mode** (`-custom`): Uses custom bot account from database credentials
    * **Standard Mode**: Uses main "botofthespecter" bot account
  * Dynamic sender_id and access_token selection based on active mode
  * Automatic BOT_USERNAME assignment (channel name for self mode, custom name for custom mode)
  * Improved error logging for failed message delivery

* **Event Processing**
  * New `process_chat_message_event()` helper function for consistent event handling
  * Orchestrates message counting, welcome messages, and point awarding
  * Simplified event processing from EventSub notifications
  * Provides centralized logging for all chat message events

* **Logging Improvements**
  * Changed multiple `warning` level logs to `error` for better issue visibility
  * Enhanced startup logging with detailed bot configuration information
  * Added comprehensive initialization logs showing channel, username, system, and version
  * Better error context in ad break notification failures

* **MySQL Query Updates**
  * Updated `INSERT ... ON DUPLICATE KEY UPDATE` syntax to MySQL 8.0+ compatible format
  * Changed from `VALUES()` function to table alias syntax (`AS new_watch_time`)
  * Improved watch_time tracking query for better compatibility

* **SSH Manager Initialization**
  * Changed SSH manager logger from `bot_logger` to `system_logger` for better categorization

**Thank you for your feedback and support!**

As always, your feedback is appreciated. Please report any issues, bugs, or suggestions in the #ticket-info channel on our Discord server. You can also submit feedback and bug reports directly on our website: [https://botofthespecter.com/feedback.php](https://botofthespecter.com/feedback.php)
